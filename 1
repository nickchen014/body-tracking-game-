<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²ªåƒæ€ªç¸å¤§é€²æ“Š (Hungry Monster Rampage) - Visual Upgrade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MediaPipe Pose -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #222;
            font-family: 'Segoe UI', sans-serif;
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿæ»‘å‹• */
        }

        canvas {
            display: block;
        }

        /* éŠæˆ²ä¸»ç•«å¸ƒ */
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        /* ä»‹é¢å±¤ */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ°ä¸‹æ–¹ */
        }

        /* ç¶²è·¯æ”å½±æ©Ÿé è¦½ (å³ä¸‹è§’) */
        #webcam-preview {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 240px;
            height: 180px;
            border: 4px solid rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            z-index: 30;
            transform: scaleX(-1); /* é¡åƒç¿»è½‰ */
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* ç‹€æ…‹æ–‡å­—ç‰¹æ•ˆ */
        .boing-text {
            animation: bounce 0.5s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* ç»ç’ƒæ“¬æ…‹ UI */
        .glass-panel {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>

    <!-- éŠæˆ²ç•«å¸ƒ -->
    <canvas id="gameCanvas"></canvas>

    <!-- Webcam é è¦½å®¹å™¨ -->
    <div id="webcam-preview">
        <video class="input_video" style="display:none;" playsinline></video>
        <canvas class="output_canvas" width="320" height="240" style="width:100%; height:100%;"></canvas>
    </div>

    <!-- UI å±¤ -->
    <div id="ui-layer" class="flex flex-col justify-between p-6">
        <!-- é ‚éƒ¨è³‡è¨Šåˆ— -->
        <div class="flex justify-between items-start pointer-events-auto relative">
            <!-- åˆ†æ•¸ -->
            <div class="glass-panel rounded-2xl px-8 py-3 shadow-xl border-l-8 border-yellow-400 transform hover:scale-105 transition duration-300">
                <span class="text-white/80 text-xs font-bold uppercase tracking-wider">Score</span>
                <div class="flex items-center gap-2">
                    <span class="text-3xl">ğŸ©</span>
                    <div id="score-display" class="text-5xl font-black text-white drop-shadow-md">0</div>
                </div>
            </div>

            <!-- æ™‚é–“ (æ–°å¢) -->
            <div class="absolute left-1/2 top-0 transform -translate-x-1/2 glass-panel rounded-2xl px-6 py-2 shadow-xl border-b-4 border-blue-400 flex flex-col items-center">
                <span class="text-white/80 text-xs font-bold uppercase tracking-wider">Time</span>
                <div id="time-display" class="text-5xl font-black text-white drop-shadow-md tabular-nums">60</div>
            </div>

            <!-- ç”Ÿå‘½å€¼ -->
            <div class="glass-panel rounded-full px-6 py-2 flex gap-2 shadow-lg" id="lives-display">
                <span class="text-4xl filter drop-shadow">â¤ï¸</span>
                <span class="text-4xl filter drop-shadow">â¤ï¸</span>
                <span class="text-4xl filter drop-shadow">â¤ï¸</span>
            </div>
        </div>

        <!-- éŠæˆ²é¸å–®/çµæŸç•«é¢ (ç½®ä¸­) -->
        <div id="menu-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm pointer-events-auto z-50">
            <h1 class="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-green-300 to-blue-600 mb-2 tracking-tighter filter drop-shadow-2xl text-stroke">
                è²ªåƒæ€ªç¸å¤§é€²æ“Š
            </h1>
            <h2 class="text-2xl text-white font-bold mb-8 tracking-widest opacity-90">HUNGRY MONSTER RAMPAGE</h2>
            
            <div class="grid grid-cols-2 gap-8 mb-10 text-center">
                <div class="bg-white/10 p-6 rounded-xl border border-white/20">
                    <div class="text-4xl mb-2">ğŸ™Œ</div>
                    <div class="text-white font-bold text-xl">é›™æ‰‹èˆ‰é«˜</div>
                    <div class="text-green-300">è·³èºåƒç”œç”œåœˆ</div>
                </div>
                <div class="bg-white/10 p-6 rounded-xl border border-white/20">
                    <div class="text-4xl mb-2">ğŸ™‡</div>
                    <div class="text-white font-bold text-xl">èº«é«”è¹²ä½</div>
                    <div class="text-yellow-300">è®Šæ‰é‘½éé¤…ä¹¾ç‰†</div>
                </div>
            </div>

            <div id="loading-msg" class="text-yellow-400 text-2xl animate-pulse font-bold">æ­£åœ¨å•Ÿå‹•æ”å½±æ©Ÿèˆ‡ AI æ¨¡å‹...</div>

            <button id="start-btn" class="hidden px-10 py-5 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white text-3xl font-black rounded-full transform transition hover:scale-110 hover:rotate-1 shadow-[0_0_30px_rgba(74,222,128,0.6)] border-4 border-white/30">
                é–‹å§‹éŠæˆ² GO!
            </button>
        </div>

        <div id="game-over-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-red-900/80 backdrop-blur-md pointer-events-auto z-50">
            <h2 class="text-8xl font-black text-white mb-4 drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]" id="game-over-title">GAME OVER</h2>
            <div class="bg-white/20 p-8 rounded-3xl backdrop-blur mb-8 text-center border border-white/30">
                <p class="text-xl text-white/80 mb-2 uppercase tracking-widest">Final Score</p>
                <p class="text-7xl font-black text-yellow-300 drop-shadow-lg" id="final-score">0</p>
            </div>
            <button id="restart-btn" class="px-8 py-4 bg-white text-red-600 text-2xl font-bold rounded-full transform transition hover:scale-110 shadow-xl border-4 border-red-200">
                å†ç©ä¸€æ¬¡ â†»
            </button>
        </div>
    </div>

    <script>
        /**
         * éŠæˆ²è¨­å®šèˆ‡å…¨åŸŸè®Šæ•¸
         */
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // ç‹€æ…‹ç®¡ç†
        const GAME_STATE = { MENU: 0, PLAYING: 1, GAMEOVER: 2 };
        let currentState = GAME_STATE.MENU;

        // éŠæˆ²åƒæ•¸
        let gameSpeed = 6;
        let score = 0;
        let lives = 3;
        let timeLeft = 60; // æ–°å¢æ™‚é–“è®Šæ•¸
        let lastTimeCheck = 0; // ç”¨æ–¼è¨ˆç®—ç§’æ•¸
        let frameCount = 0;
        let particles = [];
        let floatingTexts = [];
        let bgElements = []; // èƒŒæ™¯ç‰©ä»¶

        // ç©å®¶è¼¸å…¥
        const inputState = { isJumping: false, isSquatting: false };

        /**
         * éŸ³æ•ˆç³»çµ±
         */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'jump') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'coin') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'hit') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.5, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            } else if (type === 'squat') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.15);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            }
        }

        /**
         * é¡åˆ¥å®šç¾©
         */
        class BackgroundElement {
            constructor(type) {
                this.type = type; // 'CLOUD', 'MOUNTAIN'
                this.x = Math.random() * canvas.width;
                if (type === 'CLOUD') {
                    this.y = Math.random() * (canvas.height * 0.4);
                    this.w = 100 + Math.random() * 100;
                    this.speed = (Math.random() * 0.5 + 0.2) * 0.5; // æ…¢é€Ÿç§»å‹•
                    this.opacity = Math.random() * 0.4 + 0.4;
                } else if (type === 'MOUNTAIN') {
                    this.w = 300 + Math.random() * 400;
                    this.h = 200 + Math.random() * 200;
                    this.y = canvas.height - 100; // åœ°æ¿åŸºæº–ç·š
                    this.x = canvas.width + this.w; // å¾å³é‚Šç”Ÿæˆ
                    this.speed = gameSpeed * 0.2; // è¦–å·®æ•ˆæœ
                    this.color = `hsl(${120 + Math.random() * 40}, 30%, ${30 + Math.random() * 20}%)`;
                }
            }
            update() {
                if (this.type === 'CLOUD') {
                    this.x -= this.speed;
                    if (this.x + this.w < 0) this.x = canvas.width + 100;
                } else if (this.type === 'MOUNTAIN') {
                    this.x -= this.speed;
                }
            }
            draw() {
                ctx.save();
                if (this.type === 'CLOUD') {
                    ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
                    // ç•«é›²
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.w * 0.3, 0, Math.PI * 2);
                    ctx.arc(this.x + this.w * 0.4, this.y - this.w * 0.1, this.w * 0.4, 0, Math.PI * 2);
                    ctx.arc(this.x + this.w * 0.7, this.y + this.w * 0.1, this.w * 0.35, 0, Math.PI * 2);
                    ctx.fill();
                } else if (this.type === 'MOUNTAIN') {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(this.x + this.w / 2, this.y - this.h);
                    ctx.lineTo(this.x + this.w, this.y);
                    ctx.fill();
                }
                ctx.restore();
            }
        }

        class Player {
            constructor() {
                this.originalW = 80;
                this.originalH = 80;
                this.w = this.originalW;
                this.h = this.originalH;
                this.x = 100;
                this.y = canvas.height - 100 - this.h;
                this.vy = 0;
                this.gravity = 0.8;
                this.jumpPower = -19;
                this.groundY = canvas.height - 100;
                this.isGrounded = true;
                this.color = '#4ADE80';
                this.invincibleTimer = 0;
                this.jiggleFrame = 0;
                this.squatFactor = 1;
            }

            update() {
                const previousH = this.h;

                // è¹²ä¸‹è®Šå½¢
                if (inputState.isSquatting) {
                    const targetH = this.originalH * 0.3; // æ›´æ‰ä¸€é»
                    const targetW = this.originalW * 1.4;
                    this.h += (targetH - this.h) * 0.2;
                    this.w += (targetW - this.w) * 0.2;
                    if (this.squatFactor > 0.9) {
                        playSound('squat');
                        createParticles(this.x + this.w/2, this.y + this.h, 5, '#fff');
                    }
                    this.squatFactor = 0.35;
                } else {
                    this.h += (this.originalH - this.h) * 0.2;
                    this.w += (this.originalW - this.w) * 0.2;
                    this.squatFactor = 1;
                }

                if (this.isGrounded) this.y += (previousH - this.h);

                // è·³èº
                if (inputState.isJumping && this.isGrounded && !inputState.isSquatting) {
                    this.vy = this.jumpPower;
                    this.isGrounded = false;
                    playSound('jump');
                    createParticles(this.x + this.w / 2, this.y + this.h, 15, '#ddd');
                }

                // ç‰©ç†
                this.y += this.vy;
                if (!this.isGrounded) this.vy += this.gravity;

                if (this.y + this.h > this.groundY) {
                    this.y = this.groundY - this.h;
                    this.vy = 0;
                    this.isGrounded = true;
                }

                if (this.invincibleTimer > 0) this.invincibleTimer--;
                this.jiggleFrame += 0.15;
            }

            draw() {
                if (this.invincibleTimer > 0 && Math.floor(Date.now() / 100) % 2 === 0) return;

                ctx.save();
                
                // é™°å½± (åœ¨åœ°ä¸Š)
                if (this.isGrounded || this.y + this.h > this.groundY - 150) {
                    ctx.fillStyle = 'rgba(0,0,0,0.2)';
                    ctx.beginPath();
                    // æ ¹æ“šé«˜åº¦ç¸®æ”¾é™°å½±
                    let shadowScale = 1 - (this.groundY - (this.y + this.h)) / 200;
                    shadowScale = Math.max(0, shadowScale);
                    ctx.ellipse(this.x + this.w/2, this.groundY - 5, this.w/2 * shadowScale, 10 * shadowScale, 0, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.translate(this.x + this.w / 2, this.y + this.h);
                let bounceY = Math.sin(this.jiggleFrame) * 2;
                if (!this.isGrounded) bounceY = 0;

                // èº«é«”æ¼¸å±¤
                let grad = ctx.createLinearGradient(0, -this.h, 0, 0);
                grad.addColorStop(0, '#86EFAC');
                grad.addColorStop(1, '#22C55E');
                ctx.fillStyle = grad;

                // èº«é«”å½¢ç‹€
                ctx.beginPath();
                ctx.moveTo(-this.w / 2, 0);
                ctx.quadraticCurveTo(-this.w / 2 - 5, -this.h / 2, -this.w / 2 + 10, -this.h + bounceY);
                ctx.quadraticCurveTo(0, -this.h - 15 + bounceY, this.w / 2 - 10, -this.h + bounceY);
                ctx.quadraticCurveTo(this.w / 2 + 5, -this.h / 2, this.w / 2, 0);
                ctx.fill();
                
                // é«˜å…‰
                ctx.fillStyle = 'rgba(255,255,255,0.4)';
                ctx.beginPath();
                ctx.ellipse(-this.w * 0.2, -this.h * 0.7 + bounceY, 8, 4, Math.PI/4, 0, Math.PI*2);
                ctx.fill();

                // çœ¼ç›
                let eyeScale = this.h < this.originalH * 0.5 ? 0.7 : 1.0;
                let eyeY = -this.h * 0.6 + bounceY;
                let eyeSize = this.w * 0.15 * eyeScale;

                // çœ¼ç™½
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(-this.w * 0.2, eyeY, eyeSize, 0, Math.PI * 2);
                ctx.arc(this.w * 0.2, eyeY, eyeSize, 0, Math.PI * 2);
                ctx.fill();

                // çœ¼ç  (çœ‹è‘—å‰é€²æ–¹å‘)
                ctx.fillStyle = '#0F172A';
                ctx.beginPath();
                ctx.arc(-this.w * 0.15 + 2, eyeY, eyeSize / 2, 0, Math.PI * 2);
                ctx.arc(this.w * 0.25 + 2, eyeY, eyeSize / 2, 0, Math.PI * 2);
                ctx.fill();
                
                // è…®ç´…
                ctx.fillStyle = 'rgba(255, 100, 100, 0.3)';
                ctx.beginPath();
                ctx.arc(-this.w * 0.35, eyeY + 15, 6, 0, Math.PI * 2);
                ctx.arc(this.w * 0.35, eyeY + 15, 6, 0, Math.PI * 2);
                ctx.fill();

                ctx.restore();
            }
        }

        class Obstacle {
            constructor(type) {
                this.type = type; // 'DONUT' or 'WALL'
                this.markedForDeletion = false;
                this.oscillation = Math.random() * Math.PI;

                if (type === 'DONUT') {
                    this.w = 55;
                    this.h = 55;
                    // é«˜åº¦è®ŠåŒ–é‚è¼¯ï¼š
                    // 0.0 - 0.4: ä½ç©º (éœ€è¦ç¨å¾®æ³¨æ„)
                    // 0.4 - 0.7: ä¸­ç©º (ç«™è‘—åƒæˆ–å°è·³)
                    // 0.7 - 1.0: é«˜ç©º (å¿…é ˆè·³èº)
                    const heightRand = Math.random();
                    let offsetY;
                    
                    if (heightRand < 0.4) {
                        offsetY = 100; // ä½ç©º
                        this.flavor = 'CHOCO';
                        this.color = '#78350F';
                    } else if (heightRand < 0.7) {
                        offsetY = 180; // ä¸­ç©º
                        this.flavor = 'STRAWBERRY';
                        this.color = '#EC4899';
                    } else {
                        offsetY = 260 + Math.random() * 50; // é«˜ç©º
                        this.flavor = 'MATCHA';
                        this.color = '#84CC16';
                    }
                    
                    this.y = player.groundY - offsetY; 
                    this.x = canvas.width + 100;
                } else if (type === 'WALL') {
                    this.w = 60;
                    this.h = 400; // å¾ˆé«˜
                    // ä¿®æ”¹: é™ä½æ´å£é«˜åº¦ï¼Œå¼·è¿«ç©å®¶å¿…é ˆè¹²ä¸‹æ‰èƒ½é€šé
                    // ç©å®¶ç«™ç«‹é«˜åº¦ç´„ 80pxï¼Œåˆ¤å®šæ¡†é ‚éƒ¨ç´„åœ¨ groundY - 70px
                    // å°‡æ´å£è¨­ç‚º 45pxï¼Œç¢ºä¿ç«™ç«‹(70px)æ™‚æœƒæ’åˆ°ï¼Œè¹²ä¸‹(ç´„24px)æ™‚èƒ½é€šé
                    this.gapHeight = 45; 
                    this.y = player.groundY - this.h - this.gapHeight;
                    this.x = canvas.width + 100;
                    this.color = '#92400E';
                    this.textureType = Math.random() > 0.5 ? 'WAFER' : 'CHOCO_BAR';
                }
            }

            update() {
                this.x -= gameSpeed;
                if (this.x + this.w < -100) this.markedForDeletion = true;

                if (this.type === 'DONUT') {
                    this.y += Math.sin(this.oscillation) * 0.8;
                    this.oscillation += 0.08;
                }
            }

            draw() {
                if (this.type === 'DONUT') {
                    ctx.save();
                    ctx.translate(this.x + this.w / 2, this.y + this.h / 2);
                    ctx.rotate(this.oscillation * 0.2); // å¾®å¾®æ—‹è½‰

                    // å…‰æšˆ
                    ctx.shadowColor = this.color;
                    ctx.shadowBlur = 15;

                    // æœ¬é«”
                    ctx.lineWidth = 14;
                    ctx.strokeStyle = '#FDE68A'; // éºµåœ˜è‰²
                    ctx.beginPath();
                    ctx.arc(0, 0, 18, 0, Math.PI * 2);
                    ctx.stroke();

                    // ç³–éœœ
                    ctx.lineWidth = 10;
                    ctx.strokeStyle = this.color;
                    ctx.shadowBlur = 0; // ç³–éœœä¸éœ€è¦å…‰æšˆ
                    ctx.beginPath();
                    ctx.arc(0, -3, 18, 0, Math.PI * 2); // ç¨å¾®å¾€ä¸Šåç§»ç‡Ÿé€ æµå‹•æ„Ÿ
                    ctx.stroke();

                    // å½©è‰²ç³–ç²’
                    const sprinkles = ['#FFF', '#FF0', '#0FF', '#F0F'];
                    for(let i=0; i<6; i++) {
                        ctx.fillStyle = sprinkles[i % sprinkles.length];
                        ctx.save();
                        ctx.rotate(i * 1.0 + this.oscillation);
                        ctx.fillRect(14, 0, 4, 2);
                        ctx.restore();
                    }

                    ctx.restore();
                } else {
                    // ç•«é¤…ä¹¾ç‰†
                    ctx.save();
                    
                    // ä¸»é«”æ¼¸å±¤
                    let grad = ctx.createLinearGradient(this.x, 0, this.x + this.w, 0);
                    grad.addColorStop(0, '#78350F');
                    grad.addColorStop(0.5, '#92400E');
                    grad.addColorStop(1, '#553C2A');
                    ctx.fillStyle = grad;
                    
                    // é™°å½±
                    ctx.shadowColor = 'rgba(0,0,0,0.5)';
                    ctx.shadowBlur = 10;
                    ctx.shadowOffsetX = -5;
                    
                    ctx.fillRect(this.x, this.y, this.w, this.h);
                    ctx.shadowColor = 'transparent'; // Reset shadow

                    if (this.textureType === 'WAFER') {
                        // å¤¾å¿ƒé…¥æ ¼ç´‹
                        ctx.strokeStyle = 'rgba(255,255,255,0.1)';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        for(let i=0; i<this.h; i+=30) {
                            ctx.moveTo(this.x, this.y + i);
                            ctx.lineTo(this.x + this.w, this.y + i + 20);
                            ctx.moveTo(this.x + this.w, this.y + i);
                            ctx.lineTo(this.x, this.y + i + 20);
                        }
                        ctx.stroke();
                    } else {
                        // å·§å…‹åŠ›ç£šç´‹è·¯
                        ctx.fillStyle = 'rgba(0,0,0,0.2)';
                        ctx.fillRect(this.x + 10, this.y, 5, this.h);
                        ctx.fillRect(this.x + 45, this.y, 5, this.h);
                    }
                    
                    // åº•éƒ¨é‚Šç·£è£é£¾
                    ctx.fillStyle = '#451a03';
                    ctx.fillRect(this.x, this.y + this.h - 10, this.w, 10);
                    
                    ctx.restore();
                }
            }
        }

        class FloatingText {
            constructor(text, x, y, color) {
                this.text = text;
                this.x = x;
                this.y = y;
                this.color = color;
                this.life = 60;
                this.vy = -2;
                this.opacity = 1;
                this.scale = 1;
            }
            update() {
                this.y += this.vy;
                this.life--;
                this.opacity = Math.max(0, this.life / 60);
                if (this.life > 50) this.scale += 0.1; // å½ˆå‡ºæ•ˆæœ
                else this.scale = 1;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.scale(this.scale, this.scale);
                ctx.globalAlpha = this.opacity;
                ctx.fillStyle = this.color;
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 3;
                ctx.font = '900 32px "Segoe UI"';
                ctx.strokeText(this.text, 0, 0);
                ctx.fillText(this.text, 0, 0);
                ctx.restore();
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.size = Math.random() * 6 + 3;
                this.speedX = Math.random() * 6 - 3;
                this.speedY = Math.random() * -6 - 2;
                this.gravity = 0.4;
                this.life = 40;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.speedY += this.gravity;
                this.life--;
                this.size *= 0.92;
            }
            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        // --- å…¨åŸŸç‰©ä»¶å¯¦ä¾‹ ---
        const player = new Player();
        let obstacles = [];
        let obstacleTimer = 0;

        // åˆå§‹åŒ–èƒŒæ™¯é›²æœµ
        for(let i=0; i<5; i++) {
            bgElements.push(new BackgroundElement('CLOUD'));
        }

        // --- æ ¸å¿ƒéŠæˆ²è¿´åœˆ ---
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();

            // æ›´æ–°èƒŒæ™¯é›²æœµèˆ‡å±±
            bgElements.forEach(el => {
                el.update();
                el.draw();
            });

            // éš¨æ©Ÿç”Ÿæˆé å±±
            if (Math.random() < 0.005) {
                bgElements.push(new BackgroundElement('MOUNTAIN'));
            }
            // æ¸…ç†ç•«é¢å¤–çš„å±±
            bgElements = bgElements.filter(el => el.x + el.w > -100);

            // ç•«åœ°æ¿è£é£¾
            drawGroundDecoration();

            if (currentState === GAME_STATE.PLAYING) {
                // --- æ™‚é–“å€’æ•¸é‚è¼¯ ---
                const now = Date.now();
                if (now - lastTimeCheck >= 1000) {
                    timeLeft--;
                    document.getElementById('time-display').innerText = timeLeft;
                    lastTimeCheck = now;
                    
                    // æ™‚é–“å¿«åˆ°æ™‚è®Šæˆç´…è‰²ä¸¦éœ‡å‹•
                    const timeDisplay = document.getElementById('time-display');
                    if (timeLeft <= 10) {
                        timeDisplay.classList.add('text-red-400', 'animate-pulse');
                        timeDisplay.classList.remove('text-white');
                    }
                    
                    if (timeLeft <= 0) {
                        gameOver(true); // true ä»£è¡¨æ˜¯å› ç‚ºæ™‚é–“åˆ°
                    }
                }

                obstacleTimer++;
                // ç”Ÿæˆé »ç‡æ§åˆ¶ (éš¨åˆ†æ•¸è®Šå¿«ï¼Œä½†æœ‰ä¸Šé™)
                const spawnRate = Math.max(50, 110 - Math.min(score, 60));
                
                if (obstacleTimer > spawnRate) {
                    obstacleTimer = 0;
                    // --- èª¿æ•´æ©Ÿç‡ï¼š75% ç”œç”œåœˆ, 25% ç‰†å£ ---
                    if (Math.random() > 0.25) {
                        obstacles.push(new Obstacle('DONUT'));
                    } else {
                        obstacles.push(new Obstacle('WALL'));
                    }
                }

                obstacles.forEach((obs, index) => {
                    obs.update();
                    obs.draw();

                    if (!obs.markedForDeletion) {
                        // ç¢°æ’åˆ¤å®š (ç¸®å°åˆ¤å®šæ¡†è®“æ‰‹æ„Ÿå¥½ä¸€é»)
                        const hitX = player.x + 10;
                        const hitW = player.w - 20;
                        const hitY = player.y + 10;
                        const hitH = player.h - 20;

                        if (
                            hitX < obs.x + obs.w &&
                            hitX + hitW > obs.x &&
                            hitY < obs.y + obs.h &&
                            hitY + hitH > obs.y
                        ) {
                            if (obs.type === 'DONUT') {
                                obs.markedForDeletion = true;
                                score += 10;
                                document.getElementById('score-display').innerText = score;
                                playSound('coin');
                                createParticles(obs.x + obs.w/2, obs.y + obs.h/2, 20, obs.color);
                                floatingTexts.push(new FloatingText("+10", player.x, player.y - 50, '#FFD700'));
                            } else if (obs.type === 'WALL') {
                                if (player.invincibleTimer <= 0) {
                                    handleDamage();
                                }
                            }
                        }
                    }
                });

                obstacles = obstacles.filter(obs => !obs.markedForDeletion);
                player.update();
                player.draw();

                particles.forEach((p, i) => {
                    p.update();
                    p.draw();
                    if (p.life <= 0) particles.splice(i, 1);
                });

                floatingTexts.forEach((t, i) => {
                    t.update();
                    t.draw();
                    if (t.life <= 0) floatingTexts.splice(i, 1);
                });
            } else {
                player.draw();
            }

            requestAnimationFrame(animate);
        }

        function drawBackground() {
            // å¤©ç©ºæ¼¸å±¤
            let grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grad.addColorStop(0, '#3B82F6');
            grad.addColorStop(0.6, '#93C5FD');
            grad.addColorStop(1, '#DBEAFE');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // åœ°æ¿
            ctx.fillStyle = '#14532D'; // æ·±ç¶ åº•
            ctx.fillRect(0, player.groundY, canvas.width, canvas.height - player.groundY);
            
            // åœ°æ¿é ‚éƒ¨äº®è‰²å¸¶
            ctx.fillStyle = '#22C55E';
            ctx.fillRect(0, player.groundY, canvas.width, 25);
        }

        function drawGroundDecoration() {
            // éš¨æ©Ÿç§»å‹•çš„è‰åœ°æ•ˆæœ (åˆ©ç”¨ gameSpeed ç§»å‹•è¦–å·®)
            const time = Date.now() * 0.005;
            ctx.fillStyle = '#166534';
            for(let i=0; i<canvas.width; i+=100) {
                // è®“è‰å¢éš¨æ™‚é–“ç§»å‹•ï¼Œæ¨¡æ“¬å¥”è·‘
                let x = (i - (frameCount * gameSpeed) % canvas.width);
                if(x < 0) x += canvas.width;
                
                // ç•«å°è‰å¢
                ctx.beginPath();
                ctx.arc(x, player.groundY, 15, Math.PI, 0);
                ctx.arc(x + 20, player.groundY, 20, Math.PI, 0);
                ctx.arc(x + 40, player.groundY, 15, Math.PI, 0);
                ctx.fill();
            }
            if(currentState === GAME_STATE.PLAYING) frameCount++;
        }

        function handleDamage() {
            lives--;
            updateLivesDisplay();
            playSound('hit');
            player.invincibleTimer = 80;
            
            // éœ‡å‹•ç‰¹æ•ˆ
            const intensity = 15;
            canvas.style.transform = `translate(${Math.random()*intensity - intensity/2}px, ${Math.random()*intensity - intensity/2}px)`;
            setTimeout(() => canvas.style.transform = 'none', 100);

            createParticles(player.x + player.w/2, player.y + player.h/2, 30, '#EF4444');

            if (lives <= 0) gameOver(false);
        }

        function updateLivesDisplay() {
            const container = document.getElementById('lives-display');
            container.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                if (i < lives) container.innerHTML += '<span class="text-4xl filter drop-shadow animate-pulse">â¤ï¸</span>';
                else container.innerHTML += '<span class="text-4xl grayscale opacity-30">ğŸ’”</span>';
            }
        }

        function resetGame() {
            score = 0;
            lives = 3;
            timeLeft = 60; // é‡ç½®æ™‚é–“
            lastTimeCheck = Date.now();
            gameSpeed = 6;
            obstacles = [];
            particles = [];
            floatingTexts = [];
            document.getElementById('score-display').innerText = score;
            
            // é‡ç½®æ™‚é–“é¡¯ç¤ºæ¨£å¼
            const timeDisplay = document.getElementById('time-display');
            timeDisplay.innerText = timeLeft;
            timeDisplay.classList.remove('text-red-400', 'animate-pulse');
            timeDisplay.classList.add('text-white');

            updateLivesDisplay();
            player.y = player.groundY - player.h;
            player.vy = 0;
            currentState = GAME_STATE.PLAYING;
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
        }

        function gameOver(isTimeUp = false) {
            currentState = GAME_STATE.GAMEOVER;
            document.getElementById('final-score').innerText = score;
            const title = document.getElementById('game-over-title');
            if (isTimeUp) {
                title.innerText = "TIME'S UP!";
                title.classList.add('text-yellow-400');
                title.classList.remove('text-white');
            } else {
                title.innerText = "GAME OVER";
                title.classList.add('text-white');
                title.classList.remove('text-yellow-400');
            }
            document.getElementById('game-over-screen').classList.remove('hidden');
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (player) {
                player.groundY = canvas.height - 100;
                player.originalH = 80;
                player.h = 80;
                player.y = player.groundY - player.h;
            }
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- MediaPipe è¨­å®š ---
        const videoElement = document.getElementsByClassName('input_video')[0];
        const previewCanvas = document.getElementsByClassName('output_canvas')[0];
        const previewCtx = previewCanvas.getContext('2d');

        function onPoseResults(results) {
            previewCtx.save();
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            previewCtx.drawImage(results.image, 0, 0, previewCanvas.width, previewCanvas.height);

            if (!results.poseLandmarks) {
                inputState.isJumping = false;
                inputState.isSquatting = false;
                previewCtx.restore();
                return;
            }

            drawConnectors(previewCtx, results.poseLandmarks, POSE_CONNECTIONS, { color: '#00FF00', lineWidth: 2 });
            drawLandmarks(previewCtx, results.poseLandmarks, { color: '#FF0000', lineWidth: 1 });

            const landmarks = results.poseLandmarks;
            const nose = landmarks[0];
            const leftWrist = landmarks[15];
            const rightWrist = landmarks[16];
            const leftEar = landmarks[7];
            const rightEar = landmarks[8];

            const handsUp = (leftWrist.y < leftEar.y && rightWrist.y < rightEar.y);
            const squatThreshold = 0.55; // ç¨å¾®æ”¾å¯¬ä¸€é»åˆ¤å®š
            
            // ç¹ªè£½åˆ¤å®šç·š
            previewCtx.beginPath();
            previewCtx.moveTo(0, previewCanvas.height * squatThreshold);
            previewCtx.lineTo(previewCanvas.width, previewCanvas.height * squatThreshold);
            previewCtx.strokeStyle = 'yellow';
            previewCtx.lineWidth = 2;
            previewCtx.setLineDash([5, 5]);
            previewCtx.stroke();

            const isSquatting = (nose.y > squatThreshold);

            inputState.isJumping = handsUp;
            inputState.isSquatting = isSquatting;

            previewCtx.font = 'bold 20px Arial';
            if (handsUp) {
                previewCtx.fillStyle = '#4ADE80';
                previewCtx.fillText("â–² JUMP!", 10, 30);
            }
            if (isSquatting) {
                previewCtx.fillStyle = '#FBBF24';
                previewCtx.fillText("â–¼ SQUAT!", 10, previewCanvas.height - 20);
            }
            previewCtx.restore();
        }

        const pose = new Pose({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
        });

        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults(onPoseResults);

        const startBtn = document.getElementById('start-btn');
        const loadingMsg = document.getElementById('loading-msg');

        const camera = new Camera(videoElement, {
            onFrame: async () => { await pose.send({ image: videoElement }); },
            width: 320,
            height: 240
        });

        camera.start().then(() => {
            loadingMsg.classList.add('hidden');
            startBtn.classList.remove('hidden');
        });

        startBtn.addEventListener('click', () => {
            audioCtx.resume();
            resetGame();
        });

        document.getElementById('restart-btn').addEventListener('click', () => {
            resetGame();
        });

        animate();
    </script>
</body>
</html>
